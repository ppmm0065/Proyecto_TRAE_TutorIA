{% extends 'base.html' %}

{% block title %}Alumnos con menor promedio por nivel{% endblock %}

{% block panel_center_content %}
  <h1 class="text-xl font-semibold text-slate-800 mb-4 text-center">
    <i class="fas fa-chart-line-down text-red-500 mr-2"></i>
    Alumnos con menor promedio por nivel
  </h1>

{% if not alertas_promedio or alertas_promedio|length == 0 %}
    <div class="p-4 bg-slate-50 border border-slate-200 rounded-md text-center text-slate-600">
      No se encontraron alumnos con menor promedio por nivel.
    </div>
  {% else %}
    {# Fallback seguro: si ordered_levels está vacío o no definido, usar el orden dictsort (como antes) #}
    {% if ordered_levels is defined and ordered_levels|length > 0 %}
      <!-- Distribuir grupos por nivel en un grid para aprovechar ancho de ventana -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        {% for nivel in ordered_levels %}
          {% set alumnos = alertas_promedio.get(nivel) %}
          {% if alumnos %}
            <div class="mb-2">
              <h2 class="text-xs font-semibold text-slate-700 uppercase tracking-wider mb-2">{{ nivel }}</h2>
              <div class="space-y-2">
                {% for alumno in alumnos %}
                  <a href="{{ url_for('main.detalle_entidad', tipo_entidad='alumno', valor_codificado=alumno.nombre) }}" class="block">
                    <div class="bg-white border border-slate-200 rounded-lg shadow hover:shadow-md transition-shadow p-4">
                      <div class="flex items-start justify-between">
                        <div>
                          <p class="text-base font-semibold text-slate-800">{{ alumno.nombre }}</p>
                          <p class="text-sm text-slate-600">{{ alumno.curso_original | fix_course_characters }}</p>
                        </div>
                        <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-700">
                          Prom: {{ alumno.promedio | nota_un_decimal if alumno.promedio != 'N/A' else 'N/A' }}
                        </span>
                      </div>
                    </div>
                  </a>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    {% else %}
      {# Fallback al comportamiento original: iterar por dictsort #}
      {% for nivel, alumnos in alertas_promedio|dictsort %}
        <div class="mb-6">
          <h2 class="text-sm font-medium text-slate-700 uppercase tracking-wider mb-2">{{ nivel }}</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for alumno in alumnos %}
              <a href="{{ url_for('main.detalle_entidad', tipo_entidad='alumno', valor_codificado=alumno.nombre) }}" class="block">
                <div class="bg-white border border-slate-200 rounded-lg shadow hover:shadow-md transition-shadow p-4">
                  <div class="flex items-start justify-between">
                    <div>
                      <p class="text-base font-semibold text-slate-800">{{ alumno.nombre }}</p>
                      <p class="text-sm text-slate-600">{{ alumno.curso_original | fix_course_characters }}</p>
                    </div>
                    <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-700">
                      Prom: {{ alumno.promedio | nota_un_decimal if alumno.promedio != 'N/A' else 'N/A' }}
                    </span>
                  </div>
                </div>
              </a>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    {% endif %}
  {% endif %}

  <div class="mt-6 text-center">
    <a href="{{ url_for('main.index') }}" class="inline-flex items-center px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-md border border-slate-200 text-sm">
      <i class="fas fa-arrow-left mr-2"></i> Volver al inicio
    </a>
  </div>
{% endblock %}
