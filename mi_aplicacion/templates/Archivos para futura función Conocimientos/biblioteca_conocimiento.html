{% extends 'base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block head_extra %}
<style>
    .artifact-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .artifact-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .tag {
        display: inline-block;
        background-color: #e0e7ff; /* indigo-100 */
        color: #3730a3; /* indigo-800 */
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    /* Estilos para los botones de feedback */
    .feedback-btn {
        transition: all 0.2s ease-in-out;
    }
    .feedback-btn:hover {
        transform: scale(1.1);
    }
    .feedback-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block panel_left_content %}
    <h2 class="text-xl font-semibold text-slate-800 mb-2">Biblioteca</h2>
    <div class="bg-white p-4 rounded-lg shadow-md border border-slate-200 mb-6">
        <p class="text-sm text-slate-600">
            Explora, busca y filtra el conocimiento pedagógico documentado en la institución.
        </p>
    </div>

    <hr class="my-6 border-slate-300">

    <h3 class="text-md font-semibold text-slate-700 mb-3">Acciones</h3>
    <ul class="space-y-2 text-sm mb-6">
        <li>
             <a href="{{ url_for('main.registrar_conocimiento') }}"
               class="block w-full text-left bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2.5 px-4 rounded-lg transition duration-300 ease-in-out shadow-md">
               <i class="fas fa-plus-circle mr-2"></i> Registrar Nuevo Conocimiento
            </a>
        </li>
         <li>
            <a href="{{ url_for('main.index') }}" class="text-slate-600 hover:text-indigo-600 hover:font-semibold flex items-center pt-4">
                <i class="fas fa-arrow-left mr-2 w-4 text-center"></i> Volver al Inicio
            </a>
        </li>
    </ul>
{% endblock panel_left_content %}

{% block panel_center_content %}
<div class="max-w-7xl mx-auto">
    <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-2">Biblioteca de Conocimiento Pedagógico</h1>
    <p class="text-slate-600 mb-8">Un repositorio central de prácticas, lecciones y documentos institucionales.</p>

    <!-- Sección de Filtros -->
    <div class="bg-white p-6 rounded-lg shadow-lg border border-slate-200 mb-8">
        <h3 class="text-lg font-semibold text-slate-700 mb-4">Filtrar Conocimiento</h3>
        <form method="get" action="{{ url_for('main.biblioteca_conocimiento') }}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
                <label for="search_term" class="block text-sm font-medium text-slate-600">Término de Búsqueda:</label>
                <input type="text" name="search_term" id="search_term" value="{{ search_values.search_term or '' }}" class="mt-1 w-full rounded-md border-slate-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Buscar en título o descripción...">
            </div>
            <div>
                <label for="filter_knowledge_type" class="block text-sm font-medium text-slate-600">Tipo de Conocimiento:</label>
                <select name="filter_knowledge_type" id="filter_knowledge_type" class="mt-1 w-full rounded-md border-slate-300 shadow-sm bg-white focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Todos</option>
                    {% for type in config.TAXONOMIA_ESCOLAR['Tipo de Conocimiento'] %}
                        <option value="{{ type|lower|replace(' ', '_') }}" {% if search_values.knowledge_type == type|lower|replace(' ', '_') %}selected{% endif %}>{{ type }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="filter_tag" class="block text-sm font-medium text-slate-600">Etiqueta Específica:</label>
                <input type="text" name="filter_tag" id="filter_tag" value="{{ search_values.tags or '' }}" class="mt-1 w-full rounded-md border-slate-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej: Matemáticas, Inclusión...">
            </div>
            <div class="flex items-end">
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    <i class="fas fa-filter mr-2"></i>Aplicar Filtros
                </button>
            </div>
        </form>
    </div>

    <!-- Lista de Artefactos de Conocimiento -->
    <div class="space-y-6">
        {% if artifacts %}
            {% for artifact in artifacts %}
                <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 artifact-card">
                    <!-- ... (contenido de la tarjeta de artefacto sin cambios) ... -->
                    <h2 class="text-xl font-bold text-slate-800 mt-1">{{ artifact.related_prompt }}</h2>
                    <p>{{ artifact.follow_up_comment }}</p>

                    <!-- INICIO: Nueva Sección de Feedback -->
                    <div class="mt-4 pt-4 border-t border-slate-200 flex justify-between items-center">
                        <span class="text-sm font-medium text-slate-600">¿Fue útil este conocimiento?</span>
                        <div class="flex items-center space-x-3 feedback-container" data-artifact-id="{{ artifact.id }}">
                            <button class="feedback-btn text-slate-400 hover:text-green-500" data-feedback-type="util" title="Útil y preciso">
                                <i class="fas fa-thumbs-up text-lg"></i>
                            </button>
                            <button class="feedback-btn text-slate-400 hover:text-yellow-500" data-feedback-type="actualizar" title="Necesita actualizarse/complementarse">
                                <i class="fas fa-lightbulb text-lg"></i>
                            </button>
                            <button class="feedback-btn text-slate-400 hover:text-red-500" data-feedback-type="no_util" title="No fue útil o está desactualizado">
                                <i class="fas fa-thumbs-down text-lg"></i>
                            </button>
                            <span class="feedback-message text-xs ml-2"></span>
                        </div>
                    </div>
                    <!-- FIN: Nueva Sección de Feedback -->
                </div>
            {% endfor %}
        {% else %}
            <!-- ... (mensaje de biblioteca vacía sin cambios) ... -->
        {% endif %}
    </div>
</div>

<!-- INICIO: Modal para feedback detallado -->
<div id="feedback-comment-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-[100]">
    <div class="relative mx-auto p-6 border w-full max-w-lg shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center pb-3 border-b">
            <h3 class="text-xl font-bold text-slate-800">Proporcionar más detalles</h3>
            <button id="modal-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold">&times;</button>
        </div>
        <div class="mt-4">
            <p class="text-sm text-slate-600 mb-4">Tu comentario nos ayudará a mejorar este artefacto de conocimiento.</p>
            <input type="hidden" id="modal-artifact-id">
            <input type="hidden" id="modal-feedback-type">
            <div>
                <label for="modal-feedback-comment" class="block text-sm font-medium text-slate-700 mb-1">Comentario (opcional):</label>
                <textarea id="modal-feedback-comment" rows="4" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej: La estrategia es buena, pero sería útil añadir ejemplos para 1er ciclo..."></textarea>
            </div>
        </div>
        <div class="flex justify-end pt-4 mt-4 border-t">
            <button id="modal-cancel-btn" class="px-5 py-2 bg-slate-200 text-slate-700 text-base font-medium rounded-md hover:bg-slate-300">Cancelar</button>
            <button id="modal-save-btn" class="ml-3 px-5 py-2 bg-indigo-600 text-white text-base font-medium rounded-md hover:bg-indigo-700">Enviar Feedback</button>
        </div>
    </div>
</div>
<!-- FIN: Modal para feedback detallado -->

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const feedbackContainers = document.querySelectorAll('.feedback-container');
    const modal = document.getElementById('feedback-comment-modal');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const modalSaveBtn = document.getElementById('modal-save-btn');
    const modalArtifactIdInput = document.getElementById('modal-artifact-id');
    const modalFeedbackTypeInput = document.getElementById('modal-feedback-type');
    const modalFeedbackCommentTextarea = document.getElementById('modal-feedback-comment');

    // Función genérica para enviar feedback a la API
    function sendFeedback(artifactId, feedbackType, feedbackComment = '') {
        const container = document.querySelector(`.feedback-container[data-artifact-id='${artifactId}']`);
        const messageSpan = container.querySelector('.feedback-message');
        const buttons = container.querySelectorAll('.feedback-btn');

        buttons.forEach(btn => btn.disabled = true);
        messageSpan.textContent = 'Enviando...';
        messageSpan.className = 'feedback-message text-xs ml-2 text-slate-500';

        fetch("{{ url_for('main.api_knowledge_feedback') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                artifact_id: artifactId,
                feedback_type: feedbackType,
                feedback_comment: feedbackComment
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || 'Error del servidor') });
            }
            return response.json();
        })
        .then(data => {
            messageSpan.textContent = '¡Gracias!';
            messageSpan.className = 'feedback-message text-xs ml-2 text-green-600 font-semibold';
            // Opcional: Ocultar los botones después de un feedback exitoso
            setTimeout(() => {
                container.innerHTML = '<span class="text-sm text-slate-500">Feedback recibido.</span>';
            }, 2000);
        })
        .catch(error => {
            console.error('Error enviando feedback:', error);
            messageSpan.textContent = `Error: ${error.message}`;
            messageSpan.className = 'feedback-message text-xs ml-2 text-red-600';
            buttons.forEach(btn => btn.disabled = false);
        });
    }

    // Añadir listeners a todos los botones de feedback
    feedbackContainers.forEach(container => {
        container.querySelectorAll('.feedback-btn').forEach(button => {
            button.addEventListener('click', function() {
                const artifactId = container.dataset.artifactId;
                const feedbackType = this.dataset.feedbackType;

                if (feedbackType === 'actualizar') {
                    // Si el feedback necesita comentario, abrir el modal
                    modalArtifactIdInput.value = artifactId;
                    modalFeedbackTypeInput.value = feedbackType;
                    modalFeedbackCommentTextarea.value = '';
                    modal.classList.remove('hidden');
                } else {
                    // Para feedback simple (útil/no útil), enviar directamente
                    sendFeedback(artifactId, feedbackType);
                }
            });
        });
    });

    // Lógica para cerrar el modal
    function closeModal() {
        modal.classList.add('hidden');
    }
    modalCloseBtn.addEventListener('click', closeModal);
    modalCancelBtn.addEventListener('click', closeModal);
    window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeModal();
        }
    });

    // Lógica para guardar desde el modal
    modalSaveBtn.addEventListener('click', function() {
        const artifactId = modalArtifactIdInput.value;
        const feedbackType = modalFeedbackTypeInput.value;
        const feedbackComment = modalFeedbackCommentTextarea.value;
        
        sendFeedback(artifactId, feedbackType, feedbackComment);
        closeModal();
    });
});
</script>
{% endblock %}
