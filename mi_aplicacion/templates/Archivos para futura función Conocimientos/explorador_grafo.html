{% extends 'base.html' %}

{% block title %}Explorador del Grafo de Conocimiento{% endblock %}

{% block head_extra %}
    <!-- Librería para la visualización de grafos -->
    <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        #knowledge-graph {
            width: 100%;
            height: 75vh; /* Altura del 75% de la ventana */
            border: 1px solid #e2e8f0;
            background-color: #f8fafc;
            border-radius: 0.5rem;
        }
    </style>
{% endblock %}

{% block panel_left_content %}
    <h2 class="text-xl font-semibold text-slate-800 mb-2">Explorador de Grafo</h2>
    <div class="bg-white p-4 rounded-lg shadow-md border border-slate-200 mb-6">
        <p class="text-sm text-slate-600">
            Visualiza las conexiones entre prácticas pedagógicas, docentes, alumnos y cursos.
        </p>
    </div>

    <hr class="my-6 border-slate-300">

    <h3 class="text-md font-semibold text-slate-700 mb-3">Navegación</h3>
    <ul class="space-y-2 text-sm">
        <li>
            <a href="{{ url_for('main.index') }}" class="text-slate-600 hover:text-indigo-600 hover:font-semibold flex items-center">
                <i class="fas fa-arrow-left mr-2 w-4 text-center"></i> Volver al Inicio
            </a>
        </li>
        <li>
            <a href="{{ url_for('main.biblioteca_conocimiento') }}" class="text-slate-600 hover:text-indigo-600 hover:font-semibold flex items-center">
                <i class="fas fa-book-open mr-2 w-4 text-center"></i> Ir a la Biblioteca
            </a>
        </li>
    </ul>
{% endblock panel_left_content %}

{% block panel_center_content %}
<div class="max-w-7xl mx-auto">
    <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-2">Grafo de Conocimiento Institucional</h1>
    <p class="text-slate-600 mb-8">Navega por las interconexiones del saber hacer pedagógico del colegio.</p>

    <!-- Contenedor para el grafo -->
    <div id="loading-message" class="text-center py-10">
        <i class="fas fa-spinner fa-spin text-4xl text-indigo-500"></i>
        <p class="mt-4 text-slate-600">Cargando datos del grafo...</p>
    </div>
    <div id="knowledge-graph" class="hidden"></div>

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('knowledge-graph');
        const loadingMessage = document.getElementById('loading-message');

        // Opciones de configuración para el grafo
        const options = {
            layout: {
                hierarchical: false, // Usar un layout no jerárquico
                improvedLayout: true
            },
            physics: {
                // Configuración de la simulación física para la distribución de nodos
                forceAtlas2Based: {
                    gravitationalConstant: -50,
                    centralGravity: 0.01,
                    springLength: 200,
                    springConstant: 0.08,
                    avoidOverlap: 0.5
                },
                minVelocity: 0.75,
                solver: 'forceAtlas2Based',
                stabilization: { iterations: 150 }
            },
            interaction: {
                hover: true, // Resaltar nodos y aristas al pasar el mouse
                tooltipDelay: 300,
                navigationButtons: true, // Mostrar botones de zoom/navegación
                keyboard: true
            },
            nodes: {
                shape: 'dot',
                size: 20,
                font: {
                    size: 14,
                    color: '#334155' // slate-700
                },
                borderWidth: 2
            },
            edges: {
                width: 1.5,
                color: { inherit: 'from' },
                arrows: {
                    to: { enabled: true, scaleFactor: 0.5 }
                },
                 font: {
                    size: 10,
                    align: 'middle',
                    color: '#475569' // slate-600
                }
            },
            groups: {
                // Definición de estilos para cada tipo de nodo
                artifact: {
                    shape: 'icon',
                    icon: { face: "'Font Awesome 6 Free'", code: '\uf0eb', size: 50, color: '#f59e0b' }, // bombilla - amber-500
                    borderWidth: 3
                },
                custodian: {
                    shape: 'icon',
                    icon: { face: "'Font Awesome 6 Free'", code: '\uf007', size: 50, color: '#10b981' }, // usuario - emerald-500
                },
                alumno: {
                    shape: 'icon',
                    icon: { face: "'Font Awesome 6 Free'", code: '\uf19d', size: 50, color: '#3b82f6' }, // niño - blue-500
                },
                curso: {
                    shape: 'icon',
                    icon: { face: "'Font Awesome 6 Free'", code: '\uf51c', size: 50, color: '#8b5cf6' }, // grupo de usuarios - violet-500
                },
                tag: {
                    shape: 'dot',
                    color: '#ec4899', // pink-500
                    size: 10
                }
            }
        };

        // Llamada a la API para obtener los datos del grafo
        fetch("{{ url_for('main.api_knowledge_graph_data') }}")
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al obtener los datos del grafo.');
                }
                return response.json();
            })
            .then(data => {
                loadingMessage.classList.add('hidden');
                container.classList.remove('hidden');

                if (data.nodes && data.nodes.length > 0) {
                    // Crear el grafo con los datos recibidos
                    const network = new vis.Network(container, data, options);
                    network.on("stabilizationIterationsDone", function () {
                        network.setOptions( { physics: false } );
                    });
                } else {
                    container.innerHTML = '<p class="text-center text-slate-500 py-10">No hay artefactos de conocimiento para mostrar en el grafo.</p>';
                }
            })
            .catch(error => {
                console.error("Error:", error);
                loadingMessage.classList.add('hidden');
                container.classList.remove('hidden');
                container.innerHTML = `<p class="text-center text-red-600 py-10">Error: ${error.message}</p>`;
            });
    });
</script>
{% endblock %}
