{% extends 'base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block head_extra %}
<style>
    /* Estilos para las tarjetas del dashboard */
    .metric-card {
        background-color: white;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        border: 1px solid #e5e7eb;
    }
    .metric-title {
        color: #4b5563; /* gray-600 */
        font-weight: 600;
        font-size: 0.875rem;
        line-height: 1.25rem;
    }
    .metric-value {
        color: #111827; /* gray-900 */
        font-weight: 800;
        font-size: 2.25rem; /* text-4xl */
        line-height: 2.5rem;
    }
    .chart-container {
        height: 300px;
        position: relative;
    }
</style>
{% endblock %}

{% block panel_left_content %}
    <h2 class="text-xl font-semibold text-slate-800 mb-2">Dashboard</h2>
    <div class="bg-white p-4 rounded-lg shadow-md border border-slate-200 mb-6">
        <p class="text-sm text-slate-600">
            Vista general del estado y actividad de la base de conocimiento institucional.
        </p>
    </div>

    <hr class="my-6 border-slate-300">

    <h3 class="text-md font-semibold text-slate-700 mb-3">Navegación</h3>
    <ul class="space-y-2 text-sm">
        <li>
            <a href="{{ url_for('main.index') }}" class="text-slate-600 hover:text-indigo-600 hover:font-semibold flex items-center">
                <i class="fas fa-arrow-left mr-2 w-4 text-center"></i> Volver al Inicio
            </a>
        </li>
        <li>
            <a href="{{ url_for('main.biblioteca_conocimiento') }}" class="text-slate-600 hover:text-indigo-600 hover:font-semibold flex items-center">
                <i class="fas fa-book-open mr-2 w-4 text-center"></i> Ir a la Biblioteca
            </a>
        </li>
        <li>
            <a href="{{ url_for('main.explorador_grafo') }}" class="text-slate-600 hover:text-indigo-600 hover:font-semibold flex items-center">
                <i class="fas fa-project-diagram mr-2 w-4 text-center"></i> Ir al Grafo
            </a>
        </li>
    </ul>
{% endblock panel_left_content %}

{% block panel_center_content %}
<div class="max-w-7xl mx-auto">
    <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-2">Dashboard de Salud del Conocimiento</h1>
    <p class="text-slate-600 mb-8">Un resumen cuantitativo de la creación y uso del conocimiento pedagógico.</p>

    {% if metrics %}
    <!-- Fila de KPIs Principales -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="metric-card flex items-center space-x-4">
            <div class="bg-blue-100 p-3 rounded-full">
                <i class="fas fa-archive fa-2x text-blue-600"></i>
            </div>
            <div>
                <h3 class="metric-title">Total de Artefactos</h3>
                <p class="metric-value">{{ metrics.total_artifacts }}</p>
            </div>
        </div>
        <div class="metric-card flex items-center space-x-4">
            <div class="bg-green-100 p-3 rounded-full">
                <i class="fas fa-check-circle fa-2x text-green-600"></i>
            </div>
            <div>
                <h3 class="metric-title">Artefactos Validados</h3>
                <p class="metric-value">{{ metrics.by_status.Validado or 0 }}</p>
            </div>
        </div>
        <div class="metric-card flex items-center space-x-4">
            <div class="bg-yellow-100 p-3 rounded-full">
                <i class="fas fa-pencil-ruler fa-2x text-yellow-600"></i>
            </div>
            <div>
                <h3 class="metric-title">Artefactos en Borrador</h3>
                <p class="metric-value">{{ metrics.by_status.Borrador or 0 }}</p>
            </div>
        </div>
    </div>

    <!-- Fila de Gráficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="metric-card">
            <h3 class="metric-title mb-4 text-center">Artefactos por Tipo</h3>
            <div class="chart-container">
                <canvas id="byTypeChart"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h3 class="metric-title mb-4 text-center">Resumen de Feedback de Usuarios</h3>
            <div class="chart-container">
                <canvas id="feedbackChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Fila de Listas (Top Contribuidores y Etiquetas) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="metric-card">
            <h3 class="metric-title mb-4"><i class="fas fa-users mr-2"></i>Top 5 Contribuidores</h3>
            <ul class="space-y-3">
                {% for custodian, count in metrics.top_custodians %}
                <li class="flex justify-between items-center text-sm">
                    <span class="text-slate-700 font-medium">{{ loop.index }}. {{ custodian }}</span>
                    <span class="font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full">{{ count }}</span>
                </li>
                {% else %}
                <li class="text-slate-500 italic">No hay datos de contribuidores.</li>
                {% endfor %}
            </ul>
        </div>
        <div class="metric-card">
            <h3 class="metric-title mb-4"><i class="fas fa-tags mr-2"></i>Top 5 Etiquetas Más Usadas</h3>
            <ul class="space-y-3">
                {% for tag, count in metrics.top_tags.items() %}
                <li class="flex justify-between items-center text-sm">
                    <span class="text-slate-700 font-medium">{{ loop.index }}. {{ tag }}</span>
                    <span class="font-bold text-teal-600 bg-teal-100 px-2 py-1 rounded-full">{{ count }}</span>
                </li>
                {% else %}
                <li class="text-slate-500 italic">No hay datos de etiquetas.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    {% else %}
    <div class="text-center py-12 bg-white rounded-lg shadow-md border border-slate-200">
        <i class="fas fa-chart-line text-4xl text-slate-300 mb-4"></i>
        <h3 class="text-xl font-semibold text-slate-700">No hay datos para mostrar</h3>
        <p class="text-slate-500 mt-2">Aún no se han generado métricas. Comienza por registrar artefactos de conocimiento.</p>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const metricsData = {{ metrics|tojson|safe }};

    if (metricsData && Object.keys(metricsData).length > 0) {
        // --- Gráfico de Artefactos por Tipo ---
        const byTypeCtx = document.getElementById('byTypeChart')?.getContext('2d');
        if (byTypeCtx && metricsData.by_type && Object.keys(metricsData.by_type).length > 0) {
            new Chart(byTypeCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(metricsData.by_type),
                    datasets: [{
                        data: Object.values(metricsData.by_type),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1'],
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        // --- Gráfico de Feedback ---
        const feedbackCtx = document.getElementById('feedbackChart')?.getContext('2d');
        if (feedbackCtx && metricsData.feedback_summary) {
            new Chart(feedbackCtx, {
                type: 'bar',
                data: {
                    labels: ['Útil', 'Necesita Actualizar', 'No Útil'],
                    datasets: [{
                        label: 'Nº de Votos',
                        data: [
                            metricsData.feedback_summary.util || 0,
                            metricsData.feedback_summary.actualizar || 0,
                            metricsData.feedback_summary.no_util || 0
                        ],
                        backgroundColor: ['#22c55e', '#facc15', '#ef4444'], // green-500, yellow-400, red-500
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    }
});
</script>
{% endblock %}
