{% extends 'base.html' %}

{% block title %}Registrar Nuevo Conocimiento Pedagógico{% endblock %}

{% block head_extra %}
<style>
    /* Estilos para una mejor selección de etiquetas */
    .tag-category-container {
        max-height: 250px;
        overflow-y: auto;
    }
    .tag-label {
        display: block;
        padding: 0.5rem;
        border-radius: 0.375rem;
        transition: background-color 0.2s ease-in-out;
        cursor: pointer;
    }
    .tag-label:hover {
        background-color: #f1f5f9; /* slate-100 */
    }
    .tag-label input:checked + span {
        font-weight: 600;
        color: #4338ca; /* indigo-700 */
    }
</style>
{% endblock %}


{% block panel_left_content %}
    <h2 class="text-xl font-semibold text-slate-800 mb-2">Registro de Conocimiento</h2>
    <div class="bg-white p-4 rounded-lg shadow-md border border-slate-200 mb-6">
        <p class="text-sm text-slate-600">
            Utiliza este formulario para documentar prácticas, estrategias o lecciones aprendidas.
            Esta información enriquecerá la base de conocimiento del colegio.
        </p>
    </div>

    <hr class="my-6 border-slate-300">

    <h3 class="text-md font-semibold text-slate-700 mb-3">Navegación</h3>
    <ul class="space-y-2 text-sm">
        <li>
            <a href="{{ url_for('main.index') }}" class="text-slate-600 hover:text-indigo-600 hover:font-semibold flex items-center">
                <i class="fas fa-arrow-left mr-2 w-4 text-center"></i> Volver al Inicio
            </a>
        </li>
        <!-- En el futuro, aquí irá el enlace a la Biblioteca de Conocimiento -->
        <!--
        <li>
            <a href="#" class="text-slate-600 hover:text-indigo-600 hover:font-semibold flex items-center">
                <i class="fas fa-book-open mr-2 w-4 text-center"></i> Ir a la Biblioteca de Conocimiento
            </a>
        </li>
        -->
    </ul>
{% endblock panel_left_content %}


{% block panel_center_content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-2">Registrar Nuevo Artefacto de Conocimiento</h1>
    <p class="text-slate-600 mb-8">Completa los campos para documentar una nueva práctica, estrategia o lección aprendida.</p>

    <form action="{{ url_for('main.registrar_conocimiento') }}" method="post" id="knowledge-form" class="space-y-8 bg-white p-8 rounded-xl shadow-2xl border border-slate-200">

        <!-- Sección 1: Información General -->
        <fieldset class="space-y-4">
            <legend class="text-xl font-semibold text-indigo-700 pb-2 border-b-2 border-indigo-200 w-full">1. Información General</legend>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="knowledge_title" class="block text-sm font-medium text-slate-700 mb-1">Título del Conocimiento <span class="text-red-500">*</span></label>
                    <input type="text" id="knowledge_title" name="knowledge_title" required
                           class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Ej: Estrategia de grupos flexibles para 5º Básico">
                </div>
                <div>
                    <label for="knowledge_type" class="block text-sm font-medium text-slate-700 mb-1">Tipo de Conocimiento <span class="text-red-500">*</span></label>
                    <select id="knowledge_type" name="knowledge_type" required
                            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                        <option value="" disabled selected>-- Selecciona un tipo --</option>
                        {% for type in config.TAXONOMIA_ESCOLAR['Tipo de Conocimiento'] %}
                            {% if type != 'Documento Institucional Enriquecido' %}
                                <option value="{{ type|lower|replace(' ', '_') }}">{{ type }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div>
                <label for="knowledge_description" class="block text-sm font-medium text-slate-700 mb-1">Descripción / Comentario General <span class="text-red-500">*</span></label>
                <textarea id="knowledge_description" name="knowledge_description" rows="4" required
                          class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                          placeholder="Describe brevemente el contexto, el propósito o el resultado principal de este artefacto de conocimiento."></textarea>
            </div>
             <div>
                <label for="custodian" class="block text-sm font-medium text-slate-700 mb-1">Custodio / Experto (Tu nombre)</label>
                <input type="text" id="custodian" name="custodian"
                       class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                       placeholder="Nombre del docente o equipo responsable">
            </div>
        </fieldset>

        <!-- Sección 2: Contenido Estructurado -->
        <fieldset class="space-y-4">
            <legend class="text-xl font-semibold text-indigo-700 pb-2 border-b-2 border-indigo-200 w-full">2. Contenido Específico</legend>
             <div>
                <label for="structured_strategy" class="block text-sm font-medium text-slate-700 mb-1">Estrategia Aplicada</label>
                <textarea id="structured_strategy" name="structured_strategy" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="Describe paso a paso la estrategia o intervención que se realizó."></textarea>
            </div>
             <div>
                <label for="structured_evidence" class="block text-sm font-medium text-slate-700 mb-1">Evidencia de Resultados</label>
                <textarea id="structured_evidence" name="structured_evidence" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="¿Qué resultados se observaron? (Cualitativos o cuantitativos)"></textarea>
            </div>
             <div>
                <label for="structured_reflection" class="block text-sm font-medium text-slate-700 mb-1">Reflexión / Aprendizajes Clave</label>
                <textarea id="structured_reflection" name="structured_reflection" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="¿Qué funcionó bien? ¿Qué se podría mejorar? ¿Qué aprendiste?"></textarea>
            </div>
        </fieldset>

        <!-- Sección 3: Asociación y Etiquetado -->
        <fieldset class="space-y-4">
             <legend class="text-xl font-semibold text-indigo-700 pb-2 border-b-2 border-indigo-200 w-full">3. Asociación y Etiquetado</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="related_entity_type" class="block text-sm font-medium text-slate-700 mb-1">Asociar a (Opcional):</label>
                    <select id="related_entity_type" name="related_entity_type"
                            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                        <option value="none" {% if not prefilled_entity_type %}selected{% endif %}>General (No específico)</option>
                        <option value="alumno" {% if prefilled_entity_type == 'alumno' %}selected{% endif %}>Alumno</option>
                        <option value="curso" {% if prefilled_entity_type == 'curso' %}selected{% endif %}>Curso</option>
                    </select>
                </div>
                <div>
                    <label for="related_entity_name" class="block text-sm font-medium text-slate-700 mb-1">Nombre de la Entidad:</label>
                    <input type="text" id="related_entity_name" name="related_entity_name"
                           value="{{ prefilled_entity_name or '' }}"
                           class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-slate-100"
                           placeholder="Buscar nombre del alumno o curso..."
                           {% if not prefilled_entity_type or prefilled_entity_type == 'none' %}disabled{% endif %}>
                </div>
            </div>

            <div>
                <p class="block text-sm font-medium text-slate-700 mb-2">Etiquetas de la Taxonomía (Selecciona las que apliquen)</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 p-4 border rounded-lg bg-slate-50">
                    {% for category, tags in config.TAXONOMIA_ESCOLAR.items() %}
                    <div class="tag-category-container custom-scrollbar border-r border-slate-200 pr-4 last:border-r-0">
                        <h4 class="font-semibold text-slate-600 mb-2">{{ category }}</h4>
                        <div class="space-y-1">
                            {% for tag in tags %}
                                {% if category != 'Tipo de Conocimiento' %}
                                <label class="tag-label">
                                    <input type="checkbox" name="tags" value="{{ tag }}"
                                           class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 align-middle mr-2">
                                    <span class="text-sm text-slate-700 align-middle">{{ tag }}</span>
                                </label>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </fieldset>
        
        <!-- Botón de Envío -->
        <div class="text-right pt-4 border-t">
            <button type="submit"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 ease-in-out shadow-lg hover:shadow-xl transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                <i class="fas fa-save mr-2"></i> Guardar Artefacto
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const entityTypeSelect = document.getElementById('related_entity_type');
    const entityNameInput = document.getElementById('related_entity_name');

    function toggleEntityNameInput() {
        if (entityTypeSelect.value === 'none') {
            entityNameInput.disabled = true;
            entityNameInput.value = '';
            entityNameInput.placeholder = 'Buscar nombre del alumno o curso...';
        } else {
            entityNameInput.disabled = false;
            entityNameInput.placeholder = (entityTypeSelect.value === 'alumno') ? 'Buscar nombre del alumno...' : 'Buscar nombre del curso...';
            entityNameInput.focus();
        }
    }

    entityTypeSelect.addEventListener('change', toggleEntityNameInput);

    // No need for autocomplete here as it's a dedicated entry form.
    // Can be added later if needed by fetching student/course lists via API.
});
</script>
{% endblock %}