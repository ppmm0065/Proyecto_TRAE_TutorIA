{% extends 'base.html' %}

{% block title %}
    Chat Avanzado con IA - Colegio Piloto
{% endblock %}

{% block head_extra %}
<style>
  /* Tarjeta principal de respuesta IA */
  .ai-response-card { border: 1px solid #e5e7eb; border-radius: 12px; background: #ffffff; box-shadow: 0 8px 20px -8px rgba(0,0,0,0.25); overflow: hidden; }
  .ai-card-header { display: flex; align-items: center; gap: .5rem; padding: .75rem 1rem; background: linear-gradient(135deg, #6366f1 0%, #22c55e 100%); color: #fff; font-weight: 600; }
  .ai-card-header i { opacity: .9; }
  .ai-card-body { padding: 1rem 1.125rem; }

  /* Tipograf铆a y jerarqu铆a */
  .ai-card-body.prose h2 { font-size: 1.05rem; color: #0f172a; border-left: 3px solid #6366f1; padding-left: .5rem; margin-top: .75rem; }
  .ai-card-body.prose h3 { font-size: 1rem; color: #334155; margin-top: .5rem; }
  .ai-card-body.prose p { line-height: 1.6; color: #334155; }
  .ai-card-body.prose ul { margin-top: .5rem; margin-bottom: .5rem; }
  .ai-card-body.prose li { padding-left: .15rem; }
  .ai-card-body.prose blockquote { background: #f8fafc; border-left: 4px solid #0ea5e9; padding: .6rem .8rem; margin: .6rem 0; border-radius: 8px; color: #0f172a; }
  .ai-card-body table { width: 100%; border-collapse: collapse; font-size: .9rem; }
  .ai-card-body table th, .ai-card-body table td { border: 1px solid #e2e8f0; padding: .45rem .5rem; }
  .ai-card-body table th { background: #f1f5f9; }

  /* Callouts sem谩nticos */
  .callout { border-radius: 10px; padding: .75rem .9rem; margin: .6rem 0; border: 1px solid; }
  .callout .title { font-weight: 700; display: inline-flex; align-items: center; gap: .4rem; margin-bottom: .25rem; }
  .callout-action { background: #f5f3ff; border-color: #c4b5fd; }
  .callout-action .title { color: #6d28d9; }
  .callout-fundamentacion { background: #ecfeff; border-color: #22d3ee; }
  .callout-fundamentacion .title { color: #0ea5e9; }
  .callout-recomendacion { background: #f0fdf4; border-color: #86efac; }
  .callout-recomendacion .title { color: #16a34a; }
  .callout-objetivo { background: #fff7ed; border-color: #fdba74; }
  .callout-objetivo .title { color: #ea580c; }

  /* Burbuja del usuario mejorada */
  .user-message .user-bubble { background: linear-gradient(135deg, #6366f1 0%, #7c3aed 100%); color:#fff; }

  /* Resaltado de t铆tulos/insights */
  .insight-title { display: flex; align-items: center; gap: .5rem; background: #eef2ff; border-left: 4px solid #6366f1; padding: .5rem .75rem; border-radius: 8px; font-weight: 700; color: #1f2937; margin: .6rem 0; }
  .insight-badge { font-size: .75rem; background: #6366f1; color: #fff; border-radius: 9999px; padding: .1rem .5rem; }
  .intro-title { font-weight: 600; color: #1f2937; margin: .4rem 0; }
  /* Bloque de insight (header + desarrollo) */
  .insight-block { background: #eef2ff; border-left: 6px solid #6366f1; border-radius: 12px; padding: .55rem .8rem; margin: .75rem 0; }
  .insight-header { display: flex; align-items: center; gap: .6rem; font-weight: 700; color: #111827; }
  .insight-header .insight-badge { font-size: .8rem; background: #6366f1; color: #fff; border-radius: 9999px; padding: .15rem .6rem; display: inline-flex; align-items: center; gap: .35rem; }
  .insight-content { margin-top: .5rem; }
</style>
{% endblock %}

{% block panel_left_content %}
    {# Contenido del Panel Izquierdo - Navegaci贸n y Contexto #}
    <h2 class="text-xl font-semibold text-slate-800 mb-2">Chat Avanzado</h2>
    
    {# Cambiado 'bg-white' a 'bg-slate-50' y a帽adido borde/sombra #}
    <div class="bg-slate-50 p-4 rounded-lg shadow-sm border border-slate-200 mb-6">

        <p class="text-sm text-slate-600">Instituci贸n:</p>
        <p class="font-semibold text-indigo-700 break-words">Colegio Piloto</p>
        <p class="text-sm text-slate-600 mt-1">Archivo de datos:</p>
        <p class="font-semibold text-indigo-700 break-words text-xs">{{ session.get('uploaded_filename', 'No hay archivo cargado') }}</p>
        {% if not session.get('uploaded_filename') %}
            <p class="text-xs text-red-600 mt-1">Por favor, carga un archivo CSV desde la p谩gina principal para usar el chat.</p>
        {% endif %}
    </div>

    <hr class="my-6 border-slate-300">

    <h3 class="text-md font-semibold text-slate-700 mb-3">Navegaci贸n</h3>
    <ul class="space-y-2 text-sm">
        <li>
            <a href="{{ url_for('main.index') }}" class="text-slate-600 hover:text-indigo-600 hover:font-semibold flex items-center">
                <i class="fas fa-arrow-left mr-2 w-4 text-center"></i> Volver al Dashboard Principal
            </a>
        </li>
    </ul>
{% endblock panel_left_content %}

{% block panel_center_content %}
{# Envolvemos todo el contenido en una tarjeta 'bg-slate-50' #}
<div class="bg-slate-50 p-6 rounded-lg shadow-md border border-slate-200 h-full flex flex-col">
{# --- FIN: MODIFICACIN --- #}
    
    <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-6">
        Chat Avanzado sobre: <span class="text-indigo-600">Colegio Piloto</span>
    </h1>

    {% if not session.get('uploaded_filename') %}
        <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 p-4 mb-6" role="alert">
            <p class="font-bold">Archivo Requerido</p>
            <p>Para utilizar el chat avanzado, primero debes <a href="{{ url_for('main.index') }}" class="font-semibold underline hover:text-yellow-800">cargar un archivo CSV</a> en el dashboard principal.</p>
        </div>
    {% else %}
        {# SECCIN DE CHAT CON GEMINI #}
        {# 'flex-grow' se movi贸 al div de la tarjeta principal #}
        <div id="advanced-chat-interface" class="flex flex-col flex-grow">
            
            {# Cambiado 'bg-slate-50' a 'bg-white' para contrastar con la nueva tarjeta contenedora #}
            <div id="advanced-chat-history" class="overflow-y-auto mb-4 p-4 border border-slate-300 rounded-lg bg-white custom-scrollbar space-y-4 h-[45vh] flex-grow">

                <p class="text-sm text-slate-500 italic initial-chat-message">Inicia la conversaci贸n con una pregunta sobre los datos del Colegio Piloto.</p>
            </div>
            
            <form id="advanced-chat-form" class="flex items-start gap-3">
                <textarea id="advanced-chat-prompt" name="user_prompt_advanced_chat" rows="3"
                        
                        class="flex-grow px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-150 ease-in-out shadow-sm sm:text-sm bg-white"
                        
                        placeholder="Escribe tu pregunta o instrucci贸n sobre los datos..."></textarea>
                <button type="submit" id="send-advanced-chat-button"
                        class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg text-base transition duration-300 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                    <i class="fas fa-paper-plane"></i> Enviar
                </button>
            </form>
        </div>
        {# FIN SECCIN DE CHAT CON GEMINI #}
    {% endif %}
</div>
{% endblock panel_center_content %}

{% block scripts %}
    {{ super() }} 
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadedFilename = {{ session.get('uploaded_filename')|tojson|safe }};
        const advancedChatForm = document.getElementById('advanced-chat-form');
        const advancedChatPromptInput = document.getElementById('advanced-chat-prompt');
        const advancedChatHistoryDiv = document.getElementById('advanced-chat-history');
        const sendAdvancedChatButton = document.getElementById('send-advanced-chat-button');
        
        if (!uploadedFilename) {
            console.warn("Chat Avanzado: No hay archivo CSV cargado.");
            if (advancedChatForm) {
                advancedChatPromptInput.disabled = true;
                sendAdvancedChatButton.disabled = true;
                advancedChatPromptInput.placeholder = "Carga un archivo CSV para activar el chat.";
            }
        }

        const overlay = document.createElement('div');
        overlay.id = 'global-loading-overlay';
        overlay.className = 'fixed inset-0 bg-black/20 flex items-center justify-center z-50 hidden';
        overlay.innerHTML = '<div class="bg-white rounded-lg shadow-xl p-4 flex items-center gap-3"><i class="fas fa-spinner fa-spin text-2xl text-indigo-600"></i><span class="text-slate-700">Procesando consulta...</span></div>';
        document.body.appendChild(overlay);
        function showOverlay(){ overlay.classList.remove('hidden'); }
        function hideOverlay(){ overlay.classList.add('hidden'); }

        let currentAdvancedChatHistoryRaw = {{ advanced_chat_history|tojson|safe }};
        if (!Array.isArray(currentAdvancedChatHistoryRaw)) {
            currentAdvancedChatHistoryRaw = [];
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // NUEVO: Funci贸n para crear el div de informaci贸n de uso
        function createUsageInfoDiv(usageData) {
            if (!usageData || !usageData.total_tokens) return null;
            const cost = usageData.total_cost || 0;
            const formattedCost = `US$ ${cost.toLocaleString('en-US', {minimumFractionDigits: 6, maximumFractionDigits: 6})}`;

            const infoDiv = document.createElement('div');
            infoDiv.className = 'text-xs text-slate-400 mt-2 pl-2 border-l-2 border-slate-200';
            infoDiv.innerHTML = `
                <span><i class="fas fa-coins fa-fw"></i> Tokens: ${usageData.input_tokens} subida + ${usageData.output_tokens} bajada = <strong>${usageData.total_tokens}</strong></span>
                <span class="mx-2">|</span>
                <span><i class="fas fa-dollar-sign fa-fw"></i> Costo: <strong class="font-semibold text-slate-500">${formattedCost}</strong></span>
            `;
            return infoDiv;
        }

        // NUEVO: Funci贸n para actualizar los totales de la sesi贸n en la UI
        function updateSessionTotals(sessionData) {
            if (!sessionData) return;
            const tokensEl = document.getElementById('session-total-tokens');
            const costEl = document.getElementById('session-total-cost');
            if (tokensEl) tokensEl.textContent = sessionData.total_tokens.toLocaleString('en-US');
            if (costEl) costEl.textContent = `US$ ${sessionData.total_cost.toLocaleString('en-US', {minimumFractionDigits: 6, maximumFractionDigits: 6})}`;
        }

        function renderAdvancedChatMessage(sender, messageContent, isUserMessage, isHtmlResponse = false, usageData = null) {
            if (!advancedChatHistoryDiv) return;
            const initialPlaceholder = advancedChatHistoryDiv.querySelector('p.initial-chat-message');
            if (initialPlaceholder) initialPlaceholder.remove();

            const messageContainer = document.createElement('div');
            messageContainer.classList.add('mb-2'); 

            const messageBubble = document.createElement('div');
            messageBubble.classList.add('inline-block', 'text-sm', 'rounded-lg', 'px-3', 'py-2', 'shadow', 'max-w-full', 'break-words', 'w-full');

            if (isUserMessage) {
                messageContainer.classList.add('user-message', 'text-right');
                messageBubble.classList.add('user-bubble');
                messageBubble.innerHTML = `<strong>T煤:</strong> ${escapeHtml(messageContent).replace(/\n/g, '<br>')}`;
                messageContainer.appendChild(messageBubble);
            } else { 
                messageContainer.classList.add('gemini-message', 'text-left');
                
                if (sender === "Error") { 
                    messageBubble.classList.add('bg-red-100', 'text-red-700');
                    messageBubble.innerHTML = `<strong>Error:</strong> ${escapeHtml(messageContent)}`;
                } else { 
                    messageBubble.classList.add('bg-transparent', 'text-slate-800');
                    const enhancedHtml = isHtmlResponse ? enhanceGeminiHtml(messageContent) : enhanceGeminiHtml(`<div class="prose prose-sm max-w-none">${escapeHtml(messageContent)}</div>`);
                    messageBubble.innerHTML = enhancedHtml;
                }
                messageContainer.appendChild(messageBubble); 

                // NUEVO: A帽adir la informaci贸n de consumo si existe
                const usageInfoDiv = createUsageInfoDiv(usageData);
                if (usageInfoDiv) {
                    messageContainer.appendChild(usageInfoDiv);
                }
            }
            advancedChatHistoryDiv.appendChild(messageContainer);
            advancedChatHistoryDiv.scrollTop = advancedChatHistoryDiv.scrollHeight;
        }

        if (advancedChatHistoryDiv && currentAdvancedChatHistoryRaw.length > 0) {
            const initialPlaceholder = advancedChatHistoryDiv.querySelector('p.initial-chat-message');
            if (initialPlaceholder) initialPlaceholder.remove();
            currentAdvancedChatHistoryRaw.forEach(entry => {
                if (entry.user) renderAdvancedChatMessage("T煤", entry.user, true);
                if (entry.gemini_html) renderAdvancedChatMessage("Gemini", entry.gemini_html, false, true);
            });
        }

        if (advancedChatForm && uploadedFilename) {
            advancedChatForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const userPrompt = advancedChatPromptInput.value.trim();
                if (!userPrompt) return;

                renderAdvancedChatMessage("T煤", userPrompt, true);
                advancedChatPromptInput.value = '';
                sendAdvancedChatButton.disabled = true;
                sendAdvancedChatButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
                showOverlay();
                
                fetch("{{ url_for('main.api_submit_advanced_chat') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify({ prompt: userPrompt }),
                })
                .then(async (response) => {
                    sendAdvancedChatButton.disabled = false;
                    sendAdvancedChatButton.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar';
                    const raw = await response.text();
                    let parsed = null;
                    try {
                        parsed = JSON.parse(raw);
                    } catch (e) {
                        if (!response.ok) {
                            throw new Error(`Error del servidor (${response.status}).`);
                        }
                        // Cuerpo no JSON con 200 -> tratar como error controlado
                        return { error: 'Respuesta inesperada del servidor.' };
                    }
                    if (!response.ok) {
                        const msg = (parsed && parsed.error) ? parsed.error : `Error del servidor (${response.status}).`;
                        throw new Error(msg);
                    }
                    return parsed;
                })
                .then(data => {
                    if (data.error) { throw new Error(data.error); }
                    // MODIFICADO: Pasar datos de consumo al renderizar y actualizar totales de sesi贸n
                    renderAdvancedChatMessage("Gemini", data.html_output, false, true, data);
                    updateSessionTotals(data.consumo_sesion);
                    hideOverlay();
                })
                .catch(error => {
                    console.error('Error en el chat avanzado:', error);
                    renderAdvancedChatMessage("Error", error.message || "Ocurri贸 un error desconocido.", false, false);
                    hideOverlay();
                });
            });
        }
    });
</script>
<script>
    // Post-proceso visual del HTML de Gemini: tarjetas y callouts
    function enhanceGeminiHtml(originalHtml) {
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(`<div>${originalHtml}</div>`, 'text/html');
            const root = doc.body.firstElementChild;

            // Callouts por palabras clave
            const keywords = [
                { key: /^\s*Acci贸n:/i, cls: 'callout-action', icon: 'fas fa-bolt', title: 'Acci贸n' },
                { key: /^\s*Fundamentaci贸n:/i, cls: 'callout-fundamentacion', icon: 'fas fa-book-open', title: 'Fundamentaci贸n' },
                { key: /^\s*Recomendaci贸n(es)?:/i, cls: 'callout-recomendacion', icon: 'fas fa-lightbulb', title: 'Recomendaci贸n' },
                { key: /^\s*Objetivo(s)?:/i, cls: 'callout-objetivo', icon: 'fas fa-bullseye', title: 'Objetivos' }
            ];

            root.querySelectorAll('p').forEach(p => {
                const text = p.textContent || '';
                const match = keywords.find(k => k.key.test(text));
                if (match) {
                    const content = text.replace(match.key, '').trim();
                    const wrapper = doc.createElement('div');
                    wrapper.className = `callout ${match.cls}`;
                    wrapper.innerHTML = `<div class="title"><i class="${match.icon}"></i>${match.title}</div><div>${content}</div>`;
                    p.replaceWith(wrapper);
                }
            });

            // Resaltar t铆tulos que representen insights (frases extensas terminadas en ":")
            const isSectionTitle = (t) => {
                if (!t) return false;
                const s = t.trim();
                if (!s.endsWith(':')) return false;
                // Evitar duplicar los callouts ya tratados
                if (/^(Acci贸n|Fundamentaci贸n|Recomendaci贸n(?:es)?|Objetivo(?:s)?)\s*:/i.test(s)) return false;
                // Evitar etiquetas muy cortas
                return s.length >= 25;
            };

            // Introducciones: frases gu铆a que no deben tener icono ni barra
            const isIntroTitle = (t) => {
                if (!t) return false;
                const s = t.trim();
                if (!s.endsWith(':')) return false;
                const introPatterns = [
                    /^para\s+/i,
                    /^se\s+/i,
                    /se\s+aconsejan\s+las\s+siguintes|se\s+aconsejan\s+las\s+siguientes/i,
                    /se\s+recomienda(n)?/i,
                    /a\s+continuaci贸n/i,
                    /con\s+el\s+objetivo\s+de/i,
                    /con\s+el\s+fin\s+de/i,
                    /basad[oa]\s+en/i,
                    /bas[谩a]ndonos?\s+en/i,
                    /en\s+base\s+a/i,
                    /a\s+partir\s+de/i,
                    /con\s+base\s+en/i,
                    /se\s+identifican/i,
                    /se\s+presentan/i,
                    /se\s+exponen/i,
                    /aqui\s+te\s+presento/i,
                    /aqui\s+tienes/i,
                    /te\s+presento/i,
                    /presento\s+/i,
                    /propongo\s+/i,
                    /te\s+propongo\s+/i,
                    /ofrezco\s+/i
                ];
                // Regla adicional: si contiene verbos de introducci贸n y palabras como sugerencias/recomendaciones/apoyo, tratar como intro
                const hasIntroVerb = /(presento|propongo|ofrezco|aqui\s+te\s+presento|aqui\s+tienes|te\s+presento|te\s+propongo)/i.test(s);
                const hasSuggestWords = /(sugerencias|recomendaciones|apoyo)/i.test(s);
                return introPatterns.some(rx => rx.test(s)) || (hasIntroVerb && hasSuggestWords);
            };

            root.querySelectorAll('h1, h2, h3, h4, p').forEach(el => {
                const text = (el.textContent || '').trim();
                if (isIntroTitle(text)) {
                    const title = text.replace(/:\s*$/, '');
                    const wrapper = doc.createElement('div');
                    wrapper.className = 'intro-title';
                    wrapper.textContent = title;
                    el.replaceWith(wrapper);
                } else if (isSectionTitle(text)) {
                    const title = text.replace(/:\s*$/, '');
                    const marker = doc.createElement('div');
                    marker.className = 'insight-title';
                    // Evitar insertar el badge en t铆tulos que parezcan introducci贸n por falso positivo
                    const isIntroFalsePositive = /(presento|propongo|ofrezco|aqui\s+te\s+presento|aqui\s+tienes|te\s+presento|te\s+propongo)/i.test(text) && /(sugerencias|recomendaciones|apoyo)/i.test(text);
                    const badge = isIntroFalsePositive ? '' : `<span class="insight-badge"> Insight</span>`;
                    marker.innerHTML = `${badge}<span>${title}</span>`;
                    el.replaceWith(marker);
                }
            });

            // Agrupar cada t铆tulo de insight con su desarrollo (hasta el siguiente insight)
            let node = root.firstElementChild;
            while (node) {
                if (node.classList && node.classList.contains('insight-title')) {
                    const block = doc.createElement('div');
                    block.className = 'insight-block';
                    const header = doc.createElement('div');
                    header.className = 'insight-header';
                    header.innerHTML = node.innerHTML; // badge + t铆tulo
                    const content = doc.createElement('div');
                    content.className = 'insight-content';

                    // Mover hermanos siguientes hasta encontrar el pr贸ximo t铆tulo de insight
                    let cursor = node.nextElementSibling;
                    while (cursor && !(cursor.classList && cursor.classList.contains('insight-title'))) {
                        const next = cursor.nextElementSibling;
                        content.appendChild(cursor);
                        cursor = next;
                    }

                    block.appendChild(header);
                    if (content.children.length > 0) block.appendChild(content);
                    const replaceTarget = node;
                    node = block; // para continuar el bucle correctamente
                    root.insertBefore(block, replaceTarget);
                    root.removeChild(replaceTarget);
                }
                node = node.nextElementSibling;
            }

            // Envolver en tarjeta con cabecera
            const card = doc.createElement('div');
            card.className = 'ai-response-card';
            const header = doc.createElement('div');
            header.className = 'ai-card-header';
            header.innerHTML = '<span></span> Respuesta de IA';
            const body = doc.createElement('div');
            body.className = 'ai-card-body prose prose-sm max-w-none';
            body.innerHTML = root.innerHTML;
            card.appendChild(header);
            card.appendChild(body);
            return card.outerHTML;
        } catch (e) {
            console.warn('enhanceGeminiHtml fallo, devolviendo HTML original:', e);
            return originalHtml;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const advancedChatInput = document.getElementById('advanced-chat-prompt');
        const advancedSendButton = document.getElementById('send-advanced-chat-button');

        if (advancedChatInput && advancedSendButton) {
            advancedChatInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    advancedSendButton.click();
                }
            });
        }
    });
</script>

{% endblock scripts %}
