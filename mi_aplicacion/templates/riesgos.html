{% extends 'base.html' %}
{% block panel_center_content %}
<div class="max-w-7xl mx-auto">
  <h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-2">Mapa de Riesgo</h2>
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-4">
      <p class="text-slate-500 text-xs uppercase">Total Alto</p>
      <p class="text-2xl font-bold text-rose-600"><span id="totalHigh">{{ summary.totals.alto }}</span></p>
      <p class="text-sm text-slate-500"><span id="totalHighPct">0%</span> del total filtrado</p>
    </div>
    <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-4">
      <p class="text-slate-500 text-xs uppercase">Total Medio</p>
      <p class="text-2xl font-bold text-amber-600"><span id="totalMed">{{ summary.totals.medio }}</span></p>
      <p class="text-sm text-slate-500"><span id="totalMedPct">0%</span> del total filtrado</p>
    </div>
    <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-4">
      <p class="text-slate-500 text-xs uppercase">Total Bajo</p>
      <p class="text-2xl font-bold text-emerald-600"><span id="totalLow">{{ summary.totals.bajo }}</span></p>
      <p class="text-sm text-slate-500"><span id="totalLowPct">0%</span> del total filtrado</p>
    </div>
  </div>

  <div class="flex flex-wrap items-center gap-3 mb-4">
    <button id="toggleSensitivity" class="text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded-lg">Sensibilidad</button>
    <label class="text-sm text-slate-600">Filtrar por nivel:</label>
    <select id="levelFilter" class="border border-slate-300 rounded-lg p-2 bg-white text-sm">
      <option value="">Todos</option>
      <option value="basico">Básico</option>
      <option value="medio">Medio</option>
    </select>
    <label class="text-sm text-slate-600 ml-2">Filtrar por curso:</label>
    <select id="courseFilter" class="border border-slate-300 rounded-lg p-2 bg-white text-sm">
      <option value="">Todos</option>
      {% for course, data in summary.by_course.items() %}
        <option value="{{ course }}">{{ course }}</option>
      {% endfor %}
    </select>
    <a href="{{ url_for('main.api_risk_summary') }}" target="_blank" class="text-indigo-600 hover:text-indigo-800 text-sm">Ver JSON</a>
    <a href="{{ url_for('main.api_risk_summary_export_csv') }}" class="text-indigo-600 hover:text-indigo-800 text-sm">Descargar CSV</a>
  </div>

  <div id="sensitivityBar" class="hidden items-center gap-3 mb-4">
    <label class="text-sm text-slate-600">Promedio Alto:</label>
    <input id="avgHighInput" type="number" step="0.1" min="1" max="7" class="border border-slate-300 rounded-lg p-2 bg-white text-sm w-24">
    <label class="text-sm text-slate-600">Asignaturas <4.0 para Medio:</label>
    <input id="subjectsMediumInput" type="number" min="1" max="10" class="border border-slate-300 rounded-lg p-2 bg-white text-sm w-20">
    <label class="text-sm text-slate-600">Obs negativas Medio:</label>
    <input id="negMedInput" type="number" min="0" max="20" class="border border-slate-300 rounded-lg p-2 bg-white text-sm w-20">
    <label class="text-sm text-slate-600">Obs negativas Alto:</label>
    <input id="negHighInput" type="number" min="0" max="20" class="border border-slate-300 rounded-lg p-2 bg-white text-sm w-20">
    <button id="applySensitivity" class="text-sm bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-lg">Aplicar</button>
    <button id="resetSensitivity" class="text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded-lg">Restaurar</button>
  </div>

  <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-4 mb-6">
    <canvas id="riskChart" height="120"></canvas>
  </div>

  <h3 class="text-xl font-semibold text-slate-800 mb-3">Riesgos por Curso</h3>
  <div id="coursesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 [grid-auto-flow:dense]">
    {% for course, data in summary.by_course.items() %}
      <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden hover:shadow-xl transition-shadow duration-300" data-course="{{ course }}">
        <div class="p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center">
              <i class="fas fa-school text-indigo-600 text-lg"></i>
            </div>
            <div>
              <h3 class="font-semibold text-slate-900">{{ course }}</h3>
              <p class="text-sm text-slate-500">
                <a class="text-rose-600 font-semibold hover:underline" href="{{ url_for('main.riesgos_por_curso_nivel', level='alto', course=course) }}">Alto</a>: <span class="text-rose-600 font-semibold">{{ data.alto }}</span>
                · <a class="text-amber-600 font-semibold hover:underline" href="{{ url_for('main.riesgos_por_curso_nivel', level='medio', course=course) }}">Medio</a>: <span class="text-amber-600 font-semibold">{{ data.medio }}</span>
                · <a class="text-emerald-600 font-semibold hover:underline" href="{{ url_for('main.riesgos_por_curso_nivel', level='bajo', course=course) }}">Bajo</a>: <span class="text-emerald-600 font-semibold">{{ data.bajo }}</span>
              </p>
            </div>
          </div>
          
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const summary = {{ summary|tojson }};
function normalizeTxt(s){
  return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[º°]/g,'').toLowerCase();
}
function levelOf(course){
  const c = normalizeTxt(course);
  if(c.indexOf('medio')>=0 || c.indexOf(' med ')>=0) return 'medio';
  if(c.indexOf('basico')>=0 || c.indexOf(' bas ')>=0) return 'basico';
  return '';
}
const courses = Object.keys(summary.by_course||{});
const labels = courses;
const highs = courses.map(c=> (summary.by_course[c]||{}).alto||0);
const mediums = courses.map(c=> (summary.by_course[c]||{}).medio||0);
const lows = courses.map(c=> (summary.by_course[c]||{}).bajo||0);
const ctx = document.getElementById('riskChart').getContext('2d');
let chart = new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Alto',data:highs,backgroundColor:'rgba(220,53,69,0.6)'},{label:'Medio',data:mediums,backgroundColor:'rgba(255,193,7,0.6)'},{label:'Bajo',data:lows,backgroundColor:'rgba(40,167,69,0.6)'}]},options:{responsive:true,maintainAspectRatio:false}});
const levelFilter = document.getElementById('levelFilter');
const courseFilter = document.getElementById('courseFilter');
const toggleSensitivity = document.getElementById('toggleSensitivity');
const sensitivityBar = document.getElementById('sensitivityBar');
const avgHighInput = document.getElementById('avgHighInput');
const subjectsMediumInput = document.getElementById('subjectsMediumInput');
const negMedInput = document.getElementById('negMedInput');
const negHighInput = document.getElementById('negHighInput');
const applySensitivity = document.getElementById('applySensitivity');
const resetSensitivity = document.getElementById('resetSensitivity');
function applyFilters(){
  const lf = normalizeTxt(levelFilter.value||'');
  const cf = normalizeTxt(courseFilter.value||'');
  const cards = document.querySelectorAll('#coursesGrid [data-course]');
  cards.forEach(card=>{
    const course = normalizeTxt(card.getAttribute('data-course')||'');
    const okLevel = !lf || levelOf(course)===lf;
    const okCourse = !cf || course===cf;
    card.style.display = (okLevel && okCourse)?'':'none';
  });
  const filtered = courses.filter(c=>{
    const nc = normalizeTxt(c);
    const okLevel = !lf || levelOf(nc)===lf;
    const okCourse = !cf || nc===cf;
    return okLevel && okCourse;
  });
  chart.data.labels = filtered;
  chart.data.datasets[0].data = filtered.map(c=> (summary.by_course[c]||{}).alto||0);
  chart.data.datasets[1].data = filtered.map(c=> (summary.by_course[c]||{}).medio||0);
  chart.data.datasets[2].data = filtered.map(c=> (summary.by_course[c]||{}).bajo||0);
  chart.update();
  recomputeTotals();
}
levelFilter.addEventListener('change', applyFilters);
courseFilter.addEventListener('change', applyFilters);

toggleSensitivity.addEventListener('click', ()=>{
  if(sensitivityBar.classList.contains('hidden')) sensitivityBar.classList.remove('hidden'); else sensitivityBar.classList.add('hidden');
});

fetch("{{ url_for('main.api_risk_sensitivity') }}").then(r=>r.json()).then(cfg=>{
  avgHighInput.value = cfg.avg_below_high_threshold;
  subjectsMediumInput.value = cfg.subjects_below_medium_count;
  negMedInput.value = cfg.neg_observations_medium_count;
  negHighInput.value = cfg.neg_observations_high_count;
}).catch(()=>{});

applySensitivity.addEventListener('click', ()=>{
  const payload = {
    avg_below_high_threshold: parseFloat(avgHighInput.value||4.0),
    subjects_below_medium_count: parseInt(subjectsMediumInput.value||2),
    neg_observations_medium_count: parseInt(negMedInput.value||2),
    neg_observations_high_count: parseInt(negHighInput.value||4)
  };
  fetch("{{ url_for('main.api_risk_sensitivity') }}", {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)}).then(()=>{ location.reload(); }).catch(()=>{});
});

resetSensitivity.addEventListener('click', ()=>{
  fetch("{{ url_for('main.api_risk_sensitivity') }}", {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({reset:true})}).then(()=>{ location.reload(); }).catch(()=>{});
});
</script>
<script>
function recomputeTotals(){
  const lf = normalizeTxt(levelFilter.value||'');
  const cf = normalizeTxt(courseFilter.value||'');
  let h=0,m=0,b=0;
  const filteredCourses = Object.keys(summary.by_course||{}).filter(c=>{
    const nc = normalizeTxt(c);
    const okLevel = !lf || levelOf(nc)===lf;
    const okCourse = !cf || nc===cf;
    return okLevel && okCourse;
  });
  filteredCourses.forEach(c=>{
    const d = summary.by_course[c]||{};
    h += Number(d.alto||0); m += Number(d.medio||0); b += Number(d.bajo||0);
  });
  const th = document.getElementById('totalHigh');
  const tm = document.getElementById('totalMed');
  const tl = document.getElementById('totalLow');
  const thp = document.getElementById('totalHighPct');
  const tmp = document.getElementById('totalMedPct');
  const tlp = document.getElementById('totalLowPct');
  if(th) th.textContent = h;
  if(tm) tm.textContent = m;
  if(tl) tl.textContent = b;
  const tot = h + m + b;
  function pct(n){ return tot>0 ? ((n/tot*100).toFixed(1))+"%" : "0%"; }
  if(thp) thp.textContent = pct(h);
  if(tmp) tmp.textContent = pct(m);
  if(tlp) tlp.textContent = pct(b);
}
// Inicializar totales acorde a filtros actuales
document.addEventListener('DOMContentLoaded', recomputeTotals);
</script>
{% endblock %}
