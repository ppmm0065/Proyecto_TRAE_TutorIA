{% extends 'base.html' %}

{% block title %}
    {{ page_title|default('Plan de Intervención') }}
{% endblock %}

{% block head_extra %}
<style>
    /* Estilos base reutilizados para consistencia */
    .dashboard-tool-btn {
        background: #ffffff;
        color: #475569; /* slate-600 */
        border: 1px solid #cbd5e1; /* slate-300 */
        font-weight: 600;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        white-space: nowrap;
        font-size: 0.9rem;
        text-decoration: none;
        cursor: pointer;
    }
    .dashboard-tool-btn:hover:not(.disabled) {
        background-color: #f8fafc;
        border-color: #94a3b8;
        color: #0f172a;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .dashboard-tool-btn.primary-tool {
        background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); /* Purple */
        color: white;
        border: none;
        box-shadow: 0 4px 6px -1px rgba(139, 92, 246, 0.3);
    }
    .dashboard-tool-btn.primary-tool:hover {
        background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
        box-shadow: 0 6px 10px -1px rgba(139, 92, 246, 0.4);
    }

    /* Estilos para personalizar la salida del plan generado por IA */
    .ia-plan-content h3 { /* Para "Objetivos Claros" y "Acciones y Estrategias" */
        font-size: 1.25rem; /* text-xl */
        font-weight: 700;
        color: #1e3a8a; /* blue-900 */
        margin-top: 2rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #dbeafe; /* blue-100 */
    }
    .ia-plan-content h3:first-of-type {
        margin-top: 0;
    }
    .ia-plan-content ol {
        list-style: none;
        padding-left: 0;
        counter-reset: objective-counter;
    }
    .ia-plan-content ol > li {
        position: relative;
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: #f0f9ff; /* sky-50 */
        border-left: 4px solid #0ea5e9; /* sky-500 */
        border-radius: 0.375rem;
    }
    .ia-plan-content ol > li::before {
        counter-increment: objective-counter;
        content: counter(objective-counter);
        position: absolute;
        left: -12px;
        top: 1rem;
        width: 24px;
        height: 24px;
        background-color: #0ea5e9; /* sky-500 */
        color: white;
        border-radius: 50%;
        text-align: center;
        font-weight: bold;
        line-height: 24px;
    }

    .ia-plan-content ul { /* Para las estrategias */
        list-style: none !important; /* Evita discos en todos los niveles */
        padding-left: 0;
        margin-left: 0;
    }
    .ia-plan-content ul > li { /* Contenedor de una estrategia */
        background-color: #f9fafb; /* gray-50 */
        border: 1px solid #e5e7eb; /* gray-200 */
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .ia-plan-content ul > li > strong { /* Título de la estrategia */
        display: block;
        font-size: 1rem;
        font-weight: 600;
        color: #111827; /* gray-900 */
        margin-bottom: 0.75rem;
    }
    .ia-plan-content ul > li > ul { /* Contenedor para Acción y Fundamentación */
         padding-left: 1.25rem;
         list-style-type: disc;
    }
    .ia-plan-content ul > li > ul > li {
        margin-bottom: 0.5rem;
    }
    .ia-plan-content ul > li > ul > li strong {
        color: #4f46e5; /* indigo-600 */
    }

    /* Justificación del texto del plan de intervención (párrafos y descripciones) */
    .ia-plan-content p {
        text-align: justify;
        text-justify: inter-word;
        hyphens: auto;
    }
    /* Objetivos enumerados: justificar el contenido dentro del bloque */
    .ia-plan-content ol > li {
        text-align: justify;
        text-justify: inter-word;
        hyphens: auto;
    }
    /* Dentro de cada estrategia, justificar únicamente las líneas de Acción y Fundamentación, evitando afectar los títulos */
    .ia-plan-content ul > li > ul > li {
        text-align: justify;
        text-justify: inter-word;
        hyphens: auto;
    }
    /* Fuerza que todo el contenido después del título (Acción/Fundamentación) fluya en línea */
    .ia-plan-content ul > li > ul > li > *:not(strong) {
        display: inline;
        margin: 0;
        vertical-align: baseline;
        white-space: normal;
    }
    /* Unificar párrafos consecutivos dentro de cada item (evita saltos artificiales en Fundamentación) */
    .ia-plan-content ul > li > ul > li p {
        display: inline;
        margin: 0;
    }
    .ia-plan-content ul > li > ul > li p + p::before {
        content: " "; /* Inserta espacio entre párrafos unidos */
    }
    /* Cuando el contenido incluye listas anidadas, forzar flujo continuo */
    .ia-plan-content ul > li > ul > li ul,
    .ia-plan-content ul > li > ul > li ol {
        list-style: none !important;
        padding-left: 0;
        margin: 0;
    }
    .ia-plan-content ul > li > ul > li ul > li,
    .ia-plan-content ul > li > ul > li ol > li {
        display: inline;
        margin: 0;
    }
    .ia-plan-content ul > li > ul > li ul > li + li::before,
    .ia-plan-content ul > li > ul > li ol > li + li::before {
        content: " "; /* espacio entre elementos unidos */
    }
    /* Bloques comunes dentro del item: mantener en flujo */
    .ia-plan-content ul > li > ul > li div,
    .ia-plan-content ul > li > ul > li blockquote {
        display: inline;
        margin: 0;
    }
</style>
{% endblock %}

{% block panel_left_content %}
    <h2 class="text-xl font-semibold text-slate-800 mb-2">Plan de Intervención</h2>
    <div class="bg-white p-4 rounded-lg shadow-md border border-slate-200 mb-6">
        <p class="text-sm text-slate-600">Tipo de Entidad:</p>
        <p class="font-semibold text-indigo-700 break-words capitalize">{{ tipo_entidad }}</p>
        <p class="text-sm text-slate-600 mt-2">Nombre Entidad:</p>
        <p class="font-semibold text-indigo-700 break-words">{{ nombre_entidad }}</p>
        <p class="text-sm text-slate-600 mt-2">Archivo Origen:</p>
        <p class="font-semibold text-indigo-700 break-words">{{ filename }}</p>
        <p class="text-sm text-slate-600 mt-2">Fecha de Emisión del Plan:</p>
        <p class="font-semibold text-indigo-700 break-words">{{ fecha_emision_plan }}</p>
    </div>

    <hr class="my-6 border-slate-300">

    <h3 class="text-md font-semibold text-slate-700 mb-3">Acciones</h3>
    <ul class="space-y-2 text-sm">
        <li>
            <a href="{{ url_for('main.detalle_entidad', tipo_entidad=tipo_entidad, valor_codificado=nombre_entidad) }}" class="text-slate-600 hover:text-indigo-600 hover:font-semibold flex items-center">
                <i class="fas fa-arrow-left mr-2 w-4 text-center"></i> Volver al Detalle de {{ tipo_entidad|capitalize }}
            </a>
        </li>
        <li>
            <a href="{{ url_for('main.index') }}" class="text-slate-600 hover:text-indigo-600 hover:font-semibold flex items-center">
                <i class="fas fa-home mr-2 w-4 text-center"></i> Volver al Dashboard Principal
            </a>
        </li>
        <li>
            <a href="{{ url_for('main.generar_recursos_apoyo', tipo_entidad=tipo_entidad, valor_codificado=nombre_entidad, plan_ref=plan_ref) }}"
            class="mt-3 block w-full text-left bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2.5 px-4 rounded-lg transition duration-300 ease-in-out shadow-md hover:shadow-lg transform hover:scale-105">
                <i class="fas fa-search-plus mr-2"></i> Generar Recursos de Apoyo
            </a>
        </li>
    </ul>
{% endblock %}

{% block panel_center_content %}
<div class="flex flex-col h-full">
    <div class="flex flex-col md:flex-row justify-between items-start mb-6 gap-4">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-slate-800">
                Plan de Intervención {{ tipo_entidad }}: <span class="text-indigo-600">{{ nombre_entidad }}</span>
            </h1>
            <p class="text-lg font-normal text-slate-500 mt-1">
                Emitido el: {{ fecha_emision_plan }}
            </p>
        </div>

        <div class="flex items-center gap-2 flex-wrap">
            {% if plan_html and not plan_html.startswith("Error:") %}
                <a href="{{ url_for('main.generar_recursos_apoyo', tipo_entidad=tipo_entidad, valor_codificado=nombre_entidad, plan_ref=plan_ref) }}" 
                   class="dashboard-tool-btn primary-tool group" title="Generar Recursos de Apoyo">
                    <i class="fas fa-lightbulb"></i>
                    <span class="hidden xl:inline">Generar Recursos</span>
                </a>
                
            {% endif %}
                <a href="{{ url_for('main.detalle_entidad', tipo_entidad=tipo_entidad, valor_codificado=nombre_entidad) }}" 
                   class="dashboard-tool-btn group" title="Volver al Dashboard">
                    <i class="fas fa-arrow-left text-slate-600 group-hover:text-indigo-600"></i>
                    <span class="hidden xl:inline">Volver</span>
                </a>
        </div>
    </div>

    {% if plan_html %}
        {% if plan_html.startswith("Error:") %}
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
                <p class="font-bold">Error al generar el plan</p>
                <p>{{ plan_html|safe }}</p> 
            </div>
        {% else %}
            <div class="bg-white p-6 rounded-lg shadow-xl border border-slate-200 ia-plan-content max-w-none mb-8">
                {{ plan_html|safe }} 
            </div>

            <!-- Call to Action al final del plan -->
            <div class="flex justify-center mt-8 mb-4">
                <a href="{{ url_for('main.generar_recursos_apoyo', tipo_entidad=tipo_entidad, valor_codificado=nombre_entidad, plan_ref=plan_ref) }}"
                   class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 md:py-4 md:text-lg md:px-10 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                    <i class="fas fa-lightbulb mr-3"></i> Continuar: Generar Recursos de Apoyo
                </a>
            </div>
            <style>
              .action-control { margin-top: 0.75rem; padding: 0.5rem 0.75rem; background:#f8fafc; border:1px solid #e2e8f0; border-radius:0.5rem; display:flex; align-items:center; justify-content:space-between; }
              .action-control .left { display:flex; align-items:center; gap:0.75rem; flex-wrap:wrap; }
              .action-control label { font-size: 0.875rem; color:#334155; }
              .action-control .status { font-weight:600; color:#475569; margin-right:0.25rem; }
              .action-control .center { flex:1; text-align:center; }
              .action-control .saved { color:#16a34a; font-weight:600; display:none; }
              .action-control .saving { color:#4f46e5; font-weight:600; display:none; }
            </style>
            <script>
              (function(){
                {% set plan_id_js = plan_ref if plan_ref != 'current' else session.get('current_intervention_plan_id') %}
                const planId = {{ (plan_id_js or 0)|int }};
                const actions = {{ (actions or [])|tojson }};
                const statusMap = {};
                actions.forEach(a => { statusMap[a.action_title] = (a.status || 'pending'); });
                if (!window.CSS) window.CSS = {};
                if (!CSS.escape) CSS.escape = function(s){ return (s||'').replace(/[^a-zA-Z0-9_-]/g, '_'); };
                function slugify(s){ return (s||'').toLowerCase().trim().replace(/\s+/g,'_').replace(/[^a-z0-9_-]/g,'_'); }
                function isLabelStrong(el, label){
                  const t = (el.textContent||'').trim().toLowerCase();
                  label = label.toLowerCase();
                  return t === label || t === label.replace('á','a');
                }
                function findTitleStrong(li){
                  const strongs = li.querySelectorAll('strong');
                  for (const s of strongs){
                    const t = (s.textContent||'').trim().toLowerCase();
                    if (t !== 'acción:' && t !== 'accion:' && t !== 'fundamentación:' && t !== 'fundamentacion:') return s;
                  }
                  return null;
                }
                document.querySelectorAll('.ia-plan-content li').forEach((li, idx) => {
                  const strongs = li.querySelectorAll('strong');
                  let hasActionLabel = false;
                  strongs.forEach(st => { if (isLabelStrong(st,'Acción:')) hasActionLabel = true; });
                  if (!hasActionLabel) return;
                  // Eliminar restos de textos previos como "Estado: ..." y mensajes de guardado dentro del bloque
                  Array.from(li.childNodes).forEach(n => {
                    try {
                      const txt = (n.textContent||'').trim().toLowerCase();
                      if (n.nodeType === Node.TEXT_NODE && (txt.startsWith('estado:') || txt.includes('guardando') || txt.includes('guardado'))) n.textContent = '';
                    } catch(e){}
                  });
                  li.querySelectorAll('p,div').forEach(el => {
                    const t = (el.textContent||'').trim();
                    if (!el.querySelector('input')) {
                      el.innerHTML = el.innerHTML
                        .replace(/Estado:[^<]*/gi,'')
                        .replace(/\bAplicado\b/gi,'')
                        .replace(/\bNo\s+Aplicado\b/gi,'')
                        .replace(/\bEn\s+Proceso\b/gi,'')
                        .replace(/Guardando…?/gi,'')
                        .replace(/Guardado/gi,'')
                        .replace(/\s{2,}/g,' ');
                    }
                  });
                  const titleEl = findTitleStrong(li);
                  let title = titleEl ? (titleEl.textContent||'').trim() : '';
                  if (!title) title = 'accion_'+idx;
                  const ctrl = document.createElement('div');
                  ctrl.className = 'action-control';
                  ctrl.innerHTML = `
                    <div class="left">
                      <span class="status">Estado:</span>
                      <label><input type="radio" name="status_${slugify(title)}" value="applied"> Aplicado</label>
                      <label><input type="radio" name="status_${slugify(title)}" value="not_applied"> No Aplicado</label>
                      <label><input type="radio" name="status_${slugify(title)}" value="in_progress"> En Proceso</label>
                    </div>
                    <div class="center"><span class="saving">Guardando…</span><span class="saved">Guardado</span></div>
                  `;
                  // Insertar el control al final del li de la acción
                  li.appendChild(ctrl);
                  const current = statusMap[title] || 'pending';
                  const radios = ctrl.querySelectorAll(`input[name="status_${slugify(title)}"]`);
                  radios.forEach(r => { if (r.value === current) r.checked = true; });
                  radios.forEach(r => {
                    r.addEventListener('change', async () => {
                      const saving = ctrl.querySelector('.center .saving');
                      const saved = ctrl.querySelector('.center .saved');
                      if (saving) saving.style.display = 'inline';
                      if (saved) saved.style.display = 'none';
                      const payload = { plan_id: planId, action_title: title, status: r.value, applied_date: '', responsable: '', compliance_pct: 0, notes: '' };
                      try {
                        const res = await fetch('{{ url_for('main.api_intervention_action_status') }}', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        const j = await res.json();
                        if (res.ok) {
                          if (saved) {
                            saved.style.display = 'inline';
                            setTimeout(() => { saved.style.display = 'none'; }, 2500);
                          }
                        } else {
                          alert('Error al guardar estado: ' + (j.error||'desconocido'));
                        }
                      } catch(e){
                        alert('Error de red al guardar estado');
                      } finally {
                        if (saving) saving.style.display = 'none';
                      }
                    });
                  });
                });
              })();
            </script>
            {% if actions %}
            <div class="mt-6 bg-white p-6 rounded-lg shadow-xl border border-slate-200">
              <h2 class="text-xl font-bold text-slate-800 mb-3">Control de ejecución de intervenciones</h2>
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-slate-600">
                    <th class="text-left px-2 py-2">Acción</th>
                    <th class="text-left px-2 py-2">Estado</th>
                    <th class="text-left px-2 py-2">Fecha</th>
                    <th class="text-left px-2 py-2">Responsable</th>
                    <th class="text-left px-2 py-2">Cumplimiento (%)</th>
                    <th class="text-left px-2 py-2">Notas</th>
                    <th class="text-left px-2 py-2">Guardar</th>
                  </tr>
                </thead>
                <tbody>
                  {% for a in actions %}
                  <tr class="border-t">
                    <td class="px-2 py-2 align-top">{{ a.action_title }}</td>
                    <td class="px-2 py-2">
                      <select class="border rounded px-2 py-1" data-field="status">
                        {% set st = a.status or 'pending' %}
                        <option value="pending" {% if st=='pending' %}selected{% endif %}>Pendiente</option>
                        <option value="applied" {% if st=='applied' %}selected{% endif %}>Aplicada</option>
                        <option value="in_progress" {% if st=='in_progress' %}selected{% endif %}>En progreso</option>
                        <option value="not_applied" {% if st=='not_applied' %}selected{% endif %}>No aplicada</option>
                        <option value="not_applicable" {% if st=='not_applicable' %}selected{% endif %}>No aplicable</option>
                      </select>
                    </td>
                    <td class="px-2 py-2"><input type="date" class="border rounded px-2 py-1" data-field="applied_date" value="{{ a.applied_date or '' }}"></td>
                    <td class="px-2 py-2"><input type="text" class="border rounded px-2 py-1" data-field="responsable" value="{{ a.responsable or '' }}"></td>
                    <td class="px-2 py-2"><input type="number" step="0.1" min="0" max="100" class="border rounded px-2 py-1 w-24" data-field="compliance_pct" value="{{ a.compliance_pct or 0 }}"></td>
                    <td class="px-2 py-2"><input type="text" class="border rounded px-2 py-1 w-64" data-field="notes" value="{{ a.notes or '' }}"></td>
                    <td class="px-2 py-2">
                      <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-3 py-1 rounded" data-action-title="{{ a.action_title }}">Guardar</button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% endif %}
        {% endif %}
    {% else %}
        <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 p-4 mb-6" role="alert">
            <p class="font-bold">Información no disponible</p>
            <p>No se pudo cargar el contenido del plan de intervención.</p>
        </div>
    {% endif %}
</div>
{% endblock panel_center_content %}

{% block panel_right_content %}
    {{ super() }}
{% endblock panel_right_content %}

{% block scripts %}
    {{ super() }}
    <script>
        console.log("Página de Visualización de Plan de Intervención cargada.");

        // Normalización robusta del contenido de "Acción" y "Fundamentación":
        // 1) Reemplaza <br> por espacios.
        // 2) Colapsa espacios múltiples.
        // 3) Aplana listas/párrafos anidados en un flujo continuo SIN eliminar enlaces ni texto.
        (function(){
            const items = document.querySelectorAll('.ia-plan-content ul > li > ul > li');
            items.forEach(li => {
                const title = li.querySelector('strong');
                if (!title) return;

                // Utilidad: agregar texto normalizado al contenedor
                function appendText(container, txt) {
                    if (!txt) return;
                    const normalized = String(txt).replace(/\s+/g, ' ');
                    const lastChild = container.lastChild;
                    const needsLeadingSpace = (() => {
                        if (!lastChild) return false;
                        // Tomar el último carácter visible del contenedor
                        const lastChar = (lastChild.nodeType === Node.TEXT_NODE
                            ? lastChild.textContent
                            : lastChild.textContent || '').slice(-1);
                        const firstChar = normalized.charAt(0);
                        if (!lastChar) return false;
                        // Si el último carácter es puntuación y el siguiente comienza con letra o dígito, inserta espacio
                        if (/[\.,;:!\?\)\]\}"'»”]/.test(lastChar) && /[A-Za-zÁÉÍÓÚÜÑ0-9]/.test(firstChar)) {
                            return true;
                        }
                        // Si no hay espacio entre ambos fragmentos
                        if (!/\s/.test(lastChar) && !/\s/.test(firstChar)) {
                            return true;
                        }
                        return false;
                    })();
                    if (needsLeadingSpace) {
                        container.appendChild(document.createTextNode(' '));
                    }
                    container.appendChild(document.createTextNode(normalized));
                }
                // Utilidad: aplanar un nodo hijo (sin perder enlaces)
                function flattenNode(node, container) {
                    if (!node) return;
                    if (node.nodeType === Node.TEXT_NODE) {
                        appendText(container, node.textContent);
                        return;
                    }
                    if (node.nodeType !== Node.ELEMENT_NODE) return;
                    const tag = node.tagName;
                    if (tag === 'BR') { appendText(container, ' '); return; }
                    if (tag === 'UL' || tag === 'OL') {
                        node.querySelectorAll(':scope > li').forEach((liItem, idx, arr) => {
                            Array.from(liItem.childNodes).forEach(ch => flattenNode(ch, container));
                            if (idx < arr.length - 1) appendText(container, ' ');
                        });
                        return;
                    }
                    if (tag === 'P' || tag === 'DIV' || tag === 'BLOCKQUOTE') {
                        Array.from(node.childNodes).forEach(ch => flattenNode(ch, container));
                        appendText(container, ' ');
                        return;
                    }
                    if (tag === 'A') {
                        // Clonar el enlace para preservar estilo y atributos
                        const a = node.cloneNode(true);
                        // Asegurar que el contenido interno esté normalizado
                        const tmp = document.createElement('span');
                        Array.from(a.childNodes).forEach(ch => flattenNode(ch, tmp));
                        a.textContent = tmp.textContent; // reemplaza por versión normalizada
                        container.appendChild(a);
                        appendText(container, ' ');
                        return;
                    }
                    // Para otros elementos inline (SPAN, EM, STRONG, CODE, etc.)
                    Array.from(node.childNodes).forEach(ch => flattenNode(ch, container));
                    appendText(container, ' ');
                }

                // 1) Sustituir <br> por espacios antes de aplanar
                li.querySelectorAll('br').forEach(br => br.replaceWith(document.createTextNode(' ')));

                // 2) Construir contenedor inline con el contenido posterior al título
                const afterTitleNodes = [];
                let foundTitle = false;
                li.childNodes.forEach(n => {
                    if (!foundTitle) {
                        if (n === title) foundTitle = true;
                        return;
                    }
                    afterTitleNodes.push(n);
                });

                if (afterTitleNodes.length) {
                    const container = document.createElement('span');
                    container.style.display = 'inline';
                    afterTitleNodes.forEach(n => flattenNode(n, container));
                    afterTitleNodes.forEach(n => n.remove());
                    (function stripState(node){
                        if (!node) return;
                        if (node.nodeType === Node.TEXT_NODE) {
                            const t = node.textContent || '';
                            const idx = t.toLowerCase().indexOf('estado:');
                            if (idx >= 0) node.textContent = t.slice(0, idx).replace(/\s+$/,' ');
                            return;
                        }
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            Array.from(node.childNodes).forEach(stripState);
                        }
                    })(container);
                    const tc = container.textContent || '';
                    container.textContent = tc
                      .replace(/\bestado:.*$/gi,'')
                      .replace(/\baplicado\b/gi,'')
                      .replace(/\bno\s+aplicado\b/gi,'')
                      .replace(/\ben\s+proceso\b/gi,'')
                      .replace(/\bguardando…?\b/gi,'')
                      .replace(/\bguardado\b/gi,'')
                      .replace(/\sNo[\s\u00A0]*(?:…|\.{3})\s*$/i,'')
                      .replace(/\sNo[\s\u00A0]*$/i,'')
                      .replace(/\s{2,}/g,' ')
                      .trim();
                    li.appendChild(container);
                }
            });
        })();
    </script>
    <script>
      (function(){
        {% set plan_id_js2 = plan_ref if plan_ref != 'current' else session.get('current_intervention_plan_id') %}
        const planId = {{ (plan_id_js2 or 0)|int }};
        document.querySelectorAll('button[data-action-title]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const tr = btn.closest('tr');
            const payload = {
              plan_id: planId,
              action_title: btn.getAttribute('data-action-title'),
              status: tr.querySelector('[data-field="status"]').value,
              applied_date: tr.querySelector('[data-field="applied_date"]').value,
              responsable: tr.querySelector('[data-field="responsable"]').value,
              compliance_pct: tr.querySelector('[data-field="compliance_pct"]').value,
              notes: tr.querySelector('[data-field="notes"]').value
            };
            try {
              const res = await fetch('{{ url_for('main.api_intervention_action_status') }}', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
              });
              const j = await res.json();
              if (res.ok) {
                const prev = btn.getAttribute('data-prev-text') || 'Guardar';
                btn.setAttribute('data-prev-text', prev);
                btn.textContent = 'Guardado';
                btn.classList.remove('bg-indigo-600');
                btn.classList.add('bg-emerald-600');
                setTimeout(() => { btn.textContent = prev; btn.classList.remove('bg-emerald-600'); btn.classList.add('bg-indigo-600'); }, 2500);
              } else {
                alert('Error: ' + (j.error || 'no se pudo guardar'));
              }
            } catch(e){ alert('Error de red al guardar'); }
          })
        });
      })();
    </script>
{% endblock scripts %}
